name: Build and Push Frontend & Backend Images to ACR

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: practice_dev

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Azure Login using Service Principal
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 3: Login to Azure Container Registry
      - name: Login to ACR
        run: |
          az acr login --name acrpracticedev

      # Step 4: Build & Push Backend Image (only if backend folder changed)
      - name: Build and Push Backend Image
        env:
          ACR_NAME: acrpracticedev.azurecr.io
        run: |
          IMAGE_NAME=backend
          IMAGE_TAG=${{ github.run_number }}
          cd backend
          echo "ðŸš€ Building backend image..."
          docker build -t $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG .
          echo "ðŸ“¤ Pushing backend image to ACR..."
          docker push $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG
          cd ..

      # Step 5: Build & Push Frontend Image (only if frontend folder changed)
      - name: Build and Push Frontend Image
        env:
          ACR_NAME: acrpracticedev.azurecr.io
        run: |
          IMAGE_NAME=frontend
          IMAGE_TAG=${{ github.run_number }}
          cd frontend
          echo "ðŸš€ Building frontend image..."
          docker build -t $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG .
          echo "ðŸ“¤ Pushing frontend image to ACR..."
          docker push $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG
          cd ..

      # Step 6: Display pushed images
      - name: Show pushed image info
        run: |
          echo "âœ… Successfully pushed images (if applicable):"
          echo " - acrpracticedev.azurecr.io/backend:${{ github.run_number }}"
          echo " - acrpracticedev.azurecr.io/frontend:${{ github.run_number }}"
